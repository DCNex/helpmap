<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>åœ°å€è½‰ç¶“ç·¯åº¦å·¥å…·</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            padding: 30px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .config {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .config h3 {
            margin-bottom: 10px;
            color: #1565c0;
        }
        
        .config input, .config select {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .config small {
            color: #666;
            display: block;
            margin-top: 5px;
        }
        
        .api-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #90caf9;
        }
        
        .btn {
            padding: 12px 30px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .btn:hover {
            background: #1976d2;
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        #status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .status-info { background: #e3f2fd; color: #1565c0; }
        .status-success { background: #e8f5e9; color: #2e7d32; }
        .status-error { background: #ffebee; color: #c62828; }
        .status-warning { background: #fff3cd; color: #856404; }
        
        .progress {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #66bb6a);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        #results {
            margin-top: 30px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        
        .result-item {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }
        
        .result-item:hover {
            background: #f5f5f5;
        }
        
        .result-success { border-left: 4px solid #4caf50; }
        .result-error { border-left: 4px solid #f44336; }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #2196f3;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .api-mode {
            background: #fff3cd;
            padding: 10px 15px;
            border-radius: 6px;
            margin: 10px 0;
            display: none;
        }
        
        .api-mode.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—ºï¸ åœ°å€è½‰ç¶“ç·¯åº¦å·¥å…·</h1>
        
        <div class="config">
            <h3>Supabase è¨­å®š</h3>
            <input type="text" id="supabase-url" placeholder="Supabase URL" value="https://ccbspjdjgranbpyomxrp.supabase.co">
            <input type="password" id="supabase-key" placeholder="Supabase Service Role Key (éœ€è¦å¯«å…¥æ¬Šé™)">
            
            <div style="margin-top: 15px;">
                <label style="font-weight: bold; display: block; margin-bottom: 5px;">é¸æ“‡è³‡æ–™è¡¨:</label>
                <select id="table-select">
                    <option value="places">places (å¯µç‰©å‹å–„åœ°åœ–)</option>
                    <option value="nuisance_facilities">nuisance_facilities (å«Œæƒ¡è¨­æ–½åœ°åœ–)</option>
                </select>
            </div>
            
            <small style="color: #666;">âš ï¸ éœ€è¦ä½¿ç”¨ service_role key (Settings â†’ API â†’ service_role)</small>
            
            <!-- Google Maps API Section -->
            <div class="api-section">
                <h3>ğŸ“ Google Maps Geocoding API (æ¨è–¦)</h3>
                <input type="password" id="google-api-key" placeholder="AIzaSyDziFgEvm_rahmWFxnUdIfcGtRK6FhbQQo">
                <small style="color: #666;">
                    ğŸ”— å–å¾— API Key: <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console</a><br>
                    ğŸ’¡ å¡«å…¥å¾Œå°‡ä½¿ç”¨ Google API (æº–ç¢ºåº¦ 95%+),ç•™ç©ºå‰‡ä½¿ç”¨å…è²» API (æº–ç¢ºåº¦ 60%)
                </small>
            </div>
        </div>
        
        <div id="api-mode-info" class="api-mode"></div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="total-count">0</div>
                <div class="stat-label">ç¸½è³‡æ–™æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="need-geocode">0</div>
                <div class="stat-label">éœ€è¦è½‰æ›</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="success-count">0</div>
                <div class="stat-label">æˆåŠŸ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="error-count">0</div>
                <div class="stat-label">å¤±æ•—</div>
            </div>
        </div>
        
        <button class="btn" onclick="loadData()">1. è¼‰å…¥è³‡æ–™</button>
        <button class="btn" onclick="startGeocoding()" id="start-btn" disabled>2. é–‹å§‹è½‰æ›</button>
        
        <div id="status" class="status-info" style="display: none;"></div>
        
        <div class="progress" style="display: none;" id="progress-container">
            <div class="progress-bar" id="progress-bar">0%</div>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        const SUPABASE_URL_INPUT = document.getElementById('supabase-url');
        const SUPABASE_KEY_INPUT = document.getElementById('supabase-key');
        const GOOGLE_API_KEY_INPUT = document.getElementById('google-api-key');
        const TABLE_SELECT = document.getElementById('table-select');
        
        let placesData = [];
        let successCount = 0;
        let errorCount = 0;

        // é¡¯ç¤ºç‹€æ…‹
        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status-${type}`;
            status.style.display = 'block';
        }

        // è¼‰å…¥è³‡æ–™
        async function loadData() {
            const url = SUPABASE_URL_INPUT.value;
            const key = SUPABASE_KEY_INPUT.value;
            const tableName = TABLE_SELECT.value;
            
            if (!url || !key) {
                showStatus('è«‹å¡«å…¥ Supabase URL å’Œ Key', 'error');
                return;
            }
            
            showStatus('è¼‰å…¥è³‡æ–™ä¸­...', 'info');
            
            try {
                const response = await fetch(`${url}/rest/v1/${tableName}?select=*&lat=is.null`, {
                    headers: {
                        'apikey': key,
                        'Authorization': `Bearer ${key}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                placesData = await response.json();
                
                // æ›´æ–°çµ±è¨ˆ
                document.getElementById('total-count').textContent = placesData.length;
                document.getElementById('need-geocode').textContent = placesData.length;
                
                // æª¢æŸ¥ API æ¨¡å¼
                const googleApiKey = GOOGLE_API_KEY_INPUT.value;
                const apiModeInfo = document.getElementById('api-mode-info');
                
                if (googleApiKey) {
                    apiModeInfo.textContent = 'âœ… ä½¿ç”¨ Google Maps API (é«˜æº–ç¢ºåº¦)';
                    apiModeInfo.style.background = '#e8f5e9';
                    apiModeInfo.style.color = '#2e7d32';
                } else {
                    apiModeInfo.textContent = 'âš ï¸ ä½¿ç”¨å…è²» Nominatim API (æº–ç¢ºåº¦è¼ƒä½,å»ºè­°å¡«å…¥ Google API Key)';
                    apiModeInfo.style.background = '#fff3cd';
                    apiModeInfo.style.color = '#856404';
                }
                apiModeInfo.classList.add('active');
                
                showStatus(`âœ… è¼‰å…¥æˆåŠŸ!æ‰¾åˆ° ${placesData.length} ç­†éœ€è¦è½‰æ›çš„è³‡æ–™`, 'success');
                document.getElementById('start-btn').disabled = false;
                
            } catch (error) {
                showStatus('è¼‰å…¥å¤±æ•—: ' + error.message, 'error');
                console.error('Error:', error);
            }
        }

        // åœ°å€è½‰ç¶“ç·¯åº¦
        async function geocodeAddress(address) {
            const googleApiKey = GOOGLE_API_KEY_INPUT.value;
            
            // å¦‚æœæœ‰ Google API Key,ä½¿ç”¨ Google Geocoding
            if (googleApiKey) {
                return await geocodeWithGoogle(address, googleApiKey);
            } else {
                return await geocodeWithNominatim(address);
            }
        }

        // Google Maps Geocoding API
        async function geocodeWithGoogle(address, apiKey) {
            try {
                const response = await fetch(
                    `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&region=tw&key=${apiKey}`
                );
                
                const data = await response.json();
                
                if (data.status === 'OK' && data.results.length > 0) {
                    const location = data.results[0].geometry.location;
                    return {
                        lat: location.lat,
                        lng: location.lng,
                        success: true,
                        source: 'Google',
                        formatted_address: data.results[0].formatted_address
                    };
                } else if (data.status === 'OVER_QUERY_LIMIT') {
                    return { success: false, error: 'è¶…é Google API æŸ¥è©¢é™åˆ¶' };
                } else if (data.status === 'REQUEST_DENIED') {
                    return { success: false, error: 'Google API Key ç„¡æ•ˆæˆ–æœªå•Ÿç”¨' };
                } else if (data.status === 'ZERO_RESULTS') {
                    return { success: false, error: 'Google æ‰¾ä¸åˆ°æ­¤åœ°å€' };
                } else {
                    return { success: false, error: `Google API éŒ¯èª¤: ${data.status}` };
                }
                
            } catch (error) {
                return { success: false, error: 'Google API è«‹æ±‚å¤±æ•—: ' + error.message };
            }
        }

        // OpenStreetMap Nominatim (å…è²»ä½†è¼ƒä¸æº–ç¢º)
        async function geocodeWithNominatim(address) {
            try {
                // åŠ å…¥å°ç£é™åˆ¶æé«˜æº–ç¢ºåº¦
                const searchAddress = address.includes('å°ç£') ? address : `å°ç£ ${address}`;
                
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(searchAddress)}&format=json&limit=1&countrycodes=tw`,
                    {
                        headers: {
                            'User-Agent': 'Inspiring-Websites-Geocoder'
                        }
                    }
                );
                
                const data = await response.json();
                
                if (data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon),
                        success: true,
                        source: 'Nominatim'
                    };
                }
                
                return { success: false, error: 'Nominatim æ‰¾ä¸åˆ°åº§æ¨™' };
                
            } catch (error) {
                return { success: false, error: 'Nominatim è«‹æ±‚å¤±æ•—: ' + error.message };
            }
        }

        // æ›´æ–°è³‡æ–™åº«
        async function updatePlace(id, lat, lng) {
            const url = SUPABASE_URL_INPUT.value;
            const key = SUPABASE_KEY_INPUT.value;
            const tableName = TABLE_SELECT.value;
            
            const response = await fetch(`${url}/rest/v1/${tableName}?id=eq.${id}`, {
                method: 'PATCH',
                headers: {
                    'apikey': key,
                    'Authorization': `Bearer ${key}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=minimal'
                },
                body: JSON.stringify({ lat, lng })
            });
            
            return response.ok;
        }

        // é–‹å§‹è½‰æ›
        async function startGeocoding() {
            if (placesData.length === 0) {
                showStatus('è«‹å…ˆè¼‰å…¥è³‡æ–™', 'warning');
                return;
            }
            
            document.getElementById('start-btn').disabled = true;
            document.getElementById('progress-container').style.display = 'block';
            
            const results = document.getElementById('results');
            results.innerHTML = '';
            
            successCount = 0;
            errorCount = 0;
            
            const googleApiKey = GOOGLE_API_KEY_INPUT.value;
            const delayTime = googleApiKey ? 200 : 1500; // Google API å¯ä»¥æ›´å¿«
            
            for (let i = 0; i < placesData.length; i++) {
                const place = placesData[i];
                const progress = ((i + 1) / placesData.length * 100).toFixed(0);
                
                document.getElementById('progress-bar').style.width = progress + '%';
                document.getElementById('progress-bar').textContent = progress + '%';
                
                showStatus(`è™•ç†ä¸­: ${place.name} (${i + 1}/${placesData.length})`, 'info');
                
                const result = await geocodeAddress(place.address);
                
                const resultDiv = document.createElement('div');
                resultDiv.className = 'result-item';
                
                if (result.success) {
                    const updated = await updatePlace(place.id, result.lat, result.lng);
                    
                    if (updated) {
                        successCount++;
                        resultDiv.className += ' result-success';
                        resultDiv.innerHTML = `âœ… ${place.name} <span style="background: #4caf50; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 5px;">${result.source || 'API'}</span><br><small>${place.address} â†’ (${result.lat.toFixed(6)}, ${result.lng.toFixed(6)})</small>`;
                    } else {
                        errorCount++;
                        resultDiv.className += ' result-error';
                        resultDiv.innerHTML = `âŒ ${place.name}<br><small>æ‰¾åˆ°åº§æ¨™ä½†æ›´æ–°è³‡æ–™åº«å¤±æ•—</small>`;
                    }
                } else {
                    errorCount++;
                    resultDiv.className += ' result-error';
                    resultDiv.innerHTML = `âŒ ${place.name}<br><small>${place.address} - ${result.error}</small>`;
                }
                
                results.insertBefore(resultDiv, results.firstChild);
                
                // æ›´æ–°çµ±è¨ˆ
                document.getElementById('success-count').textContent = successCount;
                document.getElementById('error-count').textContent = errorCount;
                
                // å»¶é²é¿å…è¢«å°é–
                await new Promise(resolve => setTimeout(resolve, delayTime));
            }
            
            const successRate = ((successCount / placesData.length) * 100).toFixed(1);
            showStatus(`âœ… å®Œæˆ! æˆåŠŸ: ${successCount} (${successRate}%), å¤±æ•—: ${errorCount}`, 'success');
            document.getElementById('start-btn').disabled = false;
        }
    </script>
</body>
</html>